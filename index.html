<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D4AF37">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Na'awn">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Na'awn Delivery</title>
    <link rel="icon" href="https://i.imgur.com/OqQuD0p.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-gold: #D4AF37; --dark-gold: #AA8C2C; --bg-white: #FFFFFF; --text-dark: #333333; --light-gray: #F9F9F9; }
        body { font-family: 'Cairo', sans-serif; margin: 0; padding: 0; background-color: var(--light-gray); color: var(--text-dark); display: flex; flex-direction: column; min-height: 100vh; }
        .header { background-color: var(--bg-white); color: var(--primary-gold); text-align: center; padding: 15px; font-size: 24px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-bottom: 3px solid var(--primary-gold); position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .header img { height: 40px; margin-left: 10px; border-radius: 8px; }
        
        #promo-banner-container { background: #333; color: var(--primary-gold); overflow: hidden; white-space: nowrap; padding: 8px 0; font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--primary-gold); }
        .scrolling-text { display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; flex: 1; width: 100%; box-sizing: border-box;}
        .card { background: var(--bg-white); border-radius: 12px; padding: 25px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        input, select, textarea, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; font-family: 'Cairo', sans-serif; box-sizing: border-box; font-size: 15px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-gold); }
        button { background-color: var(--primary-gold); color: var(--bg-white); border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 15px; }
        button:hover { background-color: var(--dark-gold); }
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7;}
        .btn-danger { background-color: #dc3545; margin-top: 20px;} .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #28a745; } .btn-success:hover { background-color: #218838; }
        .btn-back { background-color: transparent; color: #666; border: 1px solid #ddd; margin-bottom: 15px; margin-top: 0;} .btn-back:hover { background-color: #eee; }
        .btn-location { background-color: #17a2b8; margin-top: 0; margin-bottom: 10px;}
        .btn-smart { background-color: #6f42c1; font-size: 14px; padding: 10px; margin-top: 5px; } .btn-smart:hover { background-color: #59339d; }
        .hidden { display: none !important; }
        .map-box { height: 300px; border-radius: 8px; margin-top: 15px; z-index: 1; width: 100%; background: #e9ecef;}
        
        #admin-heatmap { height: 350px; border: 2px solid var(--primary-gold); margin-bottom: 20px; border-radius: 12px; }

        .section-title { color: var(--primary-gold); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 25px;}
        .footer { text-align: center; padding: 20px; font-size: 13px; color: #aaa; margin-top: auto; border-top: 1px solid #eee; background: var(--bg-white); }
        .footer span { cursor: pointer; margin: 0 8px; transition: color 0.3s; font-weight: bold;} .footer span:hover { color: var(--primary-gold); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;}
        .badge-wait { background: #fff3cd; color: #856404; } .badge-prog { background: #cce5ff; color: #004085; } .badge-done { background: #d4edda; color: #155724; }
        .auto-refresh-indicator { font-size: 12px; color: green; text-align: center; margin-top: -10px; margin-bottom: 10px; }
        .eta-box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 10px; border-radius: 8px; margin-top: 10px; text-align: center; color: #2e7d32; font-weight: bold;}
        .driver-badge { display: inline-block; padding: 5px 15px; background: #333; color: var(--primary-gold); border-radius: 20px; font-weight: bold; font-size: 14px; margin-bottom: 10px;}
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 15px; margin-bottom: 30px;}
        .coupon-box { display: flex; gap: 10px; } .coupon-box input { flex: 2; margin: 0;} .coupon-box button { flex: 1; margin: 0; background: #333; }
        .success-text { color: green; font-weight: bold; font-size: 14px; margin-top: 5px; display: block;}
        
        #install-banner { background: var(--primary-gold); color: white; text-align: center; padding: 12px; position: sticky; top: 73px; z-index: 999; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        #install-banner:hover { background: var(--dark-gold); }
        
        .search-box { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 2px solid var(--primary-gold); display: flex; align-items: center; }
        .search-box input { border: none; margin: 0; padding: 5px; box-shadow: none; font-size: 15px; flex: 1; }
        .search-box input:focus { border: none; outline: none; }
        
        .cash-box { background: #fdfaf0; border: 1px solid var(--primary-gold); padding: 15px; border-radius: 8px; margin-bottom: 15px;}
        .driver-price-input { border: 2px solid #28a745; background: #f8fff9; text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="header"><img src="https://i.imgur.com/OqQuD0p.png" alt="Ø´Ø¹Ø§Ø± Ù†Ø¹Ø§ÙˆÙ†">Na'awn Delivery</div>
    
    <div id="promo-banner-container" class="hidden"><div class="scrolling-text" id="promo-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    <div id="install-banner" class="hidden"></div>

    <div class="container">
        <div id="customer-login" class="card section">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="https://i.imgur.com/OqQuD0p.png" style="width: 110px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                <h2 style="color: var(--primary-gold); margin-bottom: 5px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¹Ø§ÙˆÙ† ğŸŒŸ</h2>
                <p style="color: #666; font-size: 14px; margin-top: 0;">Ù…Ù†ØµØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø³Ø±Ø¹Ø© ÙˆØ£Ù…Ø§Ù†</p>
            </div>
            <input type="tel" id="cust-phone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ù„Ø¨Ø¯Ø¡ (Ù…Ø«Ø§Ù„: 9XXXXXXX)">
            <button onclick="loginCustomer()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ØªØªØ¨Ø¹</button>
        </div>

        <div id="customer-dashboard" class="card section hidden">
            <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…Ùƒ ğŸŒŸ</h3>
            <button onclick="checkMyOrder()" style="background-color: #17a2b8;">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ÙŠ ÙˆØªØªØ¨Ø¹Ù‡ ğŸ”„</button>
            <div id="customer-status-area" style="margin: 15px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fff;"></div>
            
            <div id="customer-map-container" class="hidden">
                <h4 class="section-title" style="margin-top:0;">ğŸ“ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h4>
                <div id="eta-display" class="hidden eta-box"></div>
                <div id="customer-map" class="map-box"></div>
            </div>

            <hr style="margin: 25px 0;">
            <h4 class="section-title">â• Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="cust-city" placeholder="Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø±ÙŠØŒ Ù†Ø²ÙˆÙ‰)">
            <input type="text" id="cust-area" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / Ø§Ù„Ø­ÙŠ (Ù…Ø«Ø§Ù„: Ø§Ù„Ø³ÙˆÙ‚ØŒ Ø§Ù„Ø±ÙŠØ¨Ø©)">
            <button onclick="getCustomerLocation(event)" class="btn-location" id="btn-get-loc">ğŸ“ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</button>
            <p id="loc-status" style="font-size: 12px; color: green; margin: -5px 0 10px 0; text-align: center; display: none;">âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­</p>
            <input type="text" id="pickup-loc" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„/Ø§Ù„Ù…Ø·Ø¹Ù…)">
            <textarea id="order-details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨..."></textarea>
            
            <label style="font-size: 14px; color: #666; font-weight: bold;">ğŸ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <div class="coupon-box"><input type="text" id="promo-code" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§"><button onclick="applyCoupon(event)" type="button">ØªØ·Ø¨ÙŠÙ‚</button></div>
            <span id="coupon-msg" class="success-text hidden"></span>

            <button onclick="submitOrder(event)" id="submit-order-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ“²</button>
            <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>

        <div id="vendor-login" class="card section hidden">
            <button class="btn-back" onclick="showSection('customer-login')">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <div style="text-align: center;"><img src="https://i.imgur.com/OqQuD0p.png" style="width: 80px; margin-bottom: 10px; border-radius: 10px;"></div>
            <h3>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙØ¬Ù‘Ø§Ø± ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù… ğŸª</h3>
            <input type="text" id="vnd-id" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ§Ø¬Ø± (ID)">
            <input type="password" id="vnd-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="loginVendor(event)">Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªØ§Ø¬Ø±</button>
        </div>

        <div id="vendor-dashboard" class="card section hidden">
            <h3 id="vendor-welcome-msg" style="color: var(--primary-gold);">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h3>
            <p style="font-size:14px; color:#666; margin-top:-10px;">Ø§Ø·Ù„Ø¨ Ù…Ù†Ø§Ø¯ÙŠØ¨ Ù„ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø²Ø¨Ø§Ø¦Ù†Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
            
            <h4 class="section-title" style="margin-top:0;">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ø²Ø¨ÙˆÙ†</h4>
            <input type="tel" id="vnd-cust-phone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ† (Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡)">
            <input type="text" id="vnd-cust-city" placeholder="Ø§Ù„ÙˆÙ„Ø§ÙŠØ© (Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø±ÙŠØŒ Ø§Ù„Ø³ÙŠØ¨)">
            <input type="text" id="vnd-cust-area" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / Ø§Ù„Ø­ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØªÙˆØ§Ø¬Ø¯ ÙÙŠÙ‡ Ø§Ù„Ø²Ø¨ÙˆÙ†">
            <textarea id="vnd-order-details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø«Ø§Ù„: 2 ÙˆØ¬Ø¨Ø© Ø¨Ø±Ø¬Ø± + 1 Ø¨ÙŠØ¨Ø³ÙŠ)"></textarea>
            <input type="number" id="vnd-order-price" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ØµÙŠÙ„Ù‡ Ù…Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø¨Ø§Ù„Ø±ÙŠØ§Ù„)">
            <button onclick="submitVendorOrder(event)">Ø·Ù„Ø¨ Ù…Ù†Ø¯ÙˆØ¨ ÙÙˆØ±Ø§Ù‹ ğŸ›µ</button>
            
            <hr style="margin: 25px 0;">
            <h4 class="section-title">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ù†Ø´Ø·Ø©</h4>
            <button onclick="fetchVendorOrders()" style="background:#17a2b8; margin-bottom:10px; font-size:14px;">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ğŸ”„</button>
            <div id="vendor-orders-list"></div>

            <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>

        <div id="driver-login" class="card section hidden">
            <button class="btn-back" onclick="showSection('customer-login')">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <div style="text-align: center;"><img src="https://i.imgur.com/OqQuD0p.png" style="width: 80px; margin-bottom: 10px; border-radius: 10px;"></div>
            <h3>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
            <input type="text" id="drv-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
            <input type="password" id="drv-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="loginDriver(event)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="driver-dashboard" class="card section hidden">
            <div style="text-align: center;">
                <h3 id="driver-welcome-msg" style="margin-bottom: 5px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ›µ</h3>
                <div id="driver-badge-display" class="driver-badge">ğŸŒŸ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ù…Ø³ØªÙˆØ§Ùƒ...</div>
                <button id="drv-status-btn" onclick="toggleDriverStatus()" style="width: auto; padding: 6px 20px; border-radius: 20px; font-size: 14px; margin-top: 0; margin-bottom: 15px;">ğŸŸ¢ Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„</button>
            </div>
            <button onclick="fetchDriverOrders(true)" style="background:#17a2b8; margin-bottom:10px;">ØªØ­Ø¯ÙŠØ« ÙˆØªÙØ¹ÙŠÙ„ Ø¬Ø±Ø³ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ğŸ””</button>
            <div id="driver-orders-list"></div>
            <div id="map-container" class="hidden" style="margin-top:20px;">
                <h4 class="section-title">ğŸ“ Ø®Ø±ÙŠØ·ØªÙƒ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h4>
                <div id="driver-map" class="map-box"></div>
            </div>
            <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>

        <div id="admin-login" class="card section hidden">
            <button class="btn-back" onclick="showSection('customer-login')">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <div style="text-align: center;"><img src="https://i.imgur.com/OqQuD0p.png" style="width: 80px; margin-bottom: 10px; border-radius: 10px;"></div>
            <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <input type="text" id="adm-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="adm-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="loginAdmin(event)">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>

        <div id="admin-dashboard" class="card section hidden">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
            <div class="auto-refresh-indicator">ğŸŸ¢ ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù</div>
            
            <div class="search-box">
                <span style="font-size: 20px;">ğŸ”</span>
                <input type="text" id="admin-search-bar" onkeyup="filterAdminOrders()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨...">
            </div>

            <h4 class="section-title">ğŸ’° Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (ÙƒØ§Ø´)</h4>
            <div id="admin-driver-cash" class="cash-box">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...</div>

            <h4 class="section-title">ğŸ”¥ Ø®Ø±ÙŠØ·Ø© ØªØ±ÙƒÙŠØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
            <div id="admin-heatmap" class="map-box"></div>

            <h4 class="section-title">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†Ø¹Ø§ÙˆÙ†</h4>
            <div class="chart-container"><canvas id="statusChart"></canvas></div>
            <div class="chart-container"><canvas id="driversChart"></canvas></div>
            
            <h4 class="section-title" style="margin-top: 10px;">ğŸ†• Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h4>
            <div id="admin-new-orders"></div>

            <h4 class="section-title">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
            <div id="admin-all-orders"></div>

            <hr style="margin-top:30px; border-top: 2px dashed #dc3545;">
            <button onclick="archiveCompletedOrders()" class="btn-danger" style="background:#8b0000; padding:18px; border-radius:12px; box-shadow: 0 4px 10px rgba(139,0,0,0.3);">ğŸ—„ï¸ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ… ÙˆØ£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</button>

            <button onclick="logout()" class="btn-back" style="margin-top:20px;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>
    </div>

    <div class="footer" id="main-footer">
        <span onclick="showSection('vendor-login')">Ø§Ù„ØªÙØ¬Ù‘Ø§Ø± ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù…</span> | 
        <span onclick="showSection('driver-login')">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span> | 
        <span onclick="showSection('admin-login')">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyT60Upjm4rQla-SzNiz9Lcap9XOPaQx73X-6t3sobRPp9WIhdFBv1M9kvaXgRuRTnM/exec'; 
        let ADMIN_PHONE = "93516953"; 

        let watchId; let adminRefreshInterval; 
        let tempCustLat = null; let tempCustLng = null; let activePromoCode = "";
        let chart1, chart2; let availableDriversData = [];
        let currentDriverStatus = "Ù…ØªØµÙ„";

        const adminAudio = new Audio('https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg');
        const driverAudio = new Audio('https://actions.google.com/sounds/v1/communications/incoming_phone_call.ogg');
        let lastNewOrdersCount = 0; let lastAssignedOrdersCount = 0; let isAudioAllowed = false;

        // PWA
        let deferredPrompt; const installBanner = document.getElementById('install-banner');
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = ('standalone' in window.navigator) && (window.navigator.standalone);

        if (isIOS && !isStandalone) {
            installBanner.innerHTML = 'ğŸ“² Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø¢ÙŠÙÙˆÙ†: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ â— Ø«Ù… Ø§Ø®ØªØ§Ø± "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â•"'; installBanner.classList.remove('hidden');
            installBanner.onclick = () => { alert('ÙÙŠ Ù…ØªØµÙØ­ Ø³ÙØ§Ø±ÙŠ: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©ØŒ Ø«Ù… "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".'); };
        } else {
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBanner.innerHTML = 'ğŸ“² Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªØ«Ø¨ÙŠØª ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¹Ø§ÙˆÙ†'; installBanner.classList.remove('hidden'); });
            installBanner.onclick = () => { installBanner.classList.add('hidden'); if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => { deferredPrompt = null; }); } };
        }
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').catch(err => console.log('SW fail: ', err)); }); }

        window.addEventListener('DOMContentLoaded', () => {
            loadSettings(); 
            if (localStorage.getItem('adminLogged') === 'true') { showSection('admin-dashboard'); startAdminAutoRefresh(); }
            else if (localStorage.getItem('driverId')) { 
                document.getElementById('driver-welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${localStorage.getItem('driverName')}`; 
                applyDriverStatusUI(localStorage.getItem('driverStatus') || "Ù…ØªØµÙ„");
                showSection('driver-dashboard'); fetchDriverOrders(false); 
            }
            else if (localStorage.getItem('vendorId')) {
                document.getElementById('vendor-welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ù…ØªØ¬Ø± ${localStorage.getItem('vendorName')} ğŸª`;
                showSection('vendor-dashboard'); fetchVendorOrders();
            }
            else if (localStorage.getItem('customerPhone')) { showSection('customer-dashboard'); checkMyOrder(); }
        });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            if(sectionId.includes('dashboard')) document.getElementById('main-footer').classList.add('hidden');
            else document.getElementById('main-footer').classList.remove('hidden');
            if(sectionId !== 'admin-dashboard') stopAdminAutoRefresh();
        }

        function logout() { if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) { localStorage.clear(); if(watchId && navigator.geolocation) navigator.geolocation.clearWatch(watchId); stopAdminAutoRefresh(); showSection('customer-login'); } }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            if(!lat1 || !lon1 || !lat2 || !lon2) return null; const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1); 
        }

        function loadSettings() {
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_settings' }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success' && data.settings) {
                    if(data.settings.banner) { document.getElementById('promo-text').innerText = data.settings.banner; document.getElementById('promo-banner-container').classList.remove('hidden'); }
                    if(data.settings.adminPhone) { ADMIN_PHONE = data.settings.adminPhone; }
                }
            });
        }

        let heatmap;
        function renderHeatmap(orders) {
            if(!heatmap) { heatmap = L.map('admin-heatmap').setView([23.2255, 56.5165], 8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(heatmap); }
            heatmap.eachLayer((layer) => { if (layer instanceof L.Circle) heatmap.removeLayer(layer); });
            orders.forEach(o => { if(o.custLat && o.custLng) { L.circle([o.custLat, o.custLng], { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 500 }).addTo(heatmap); } });
            setTimeout(() => heatmap.invalidateSize(), 500);
        }

        /* ================= Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (F2C) ================= */
        function loginCustomer() { const p = document.getElementById('cust-phone').value; if(p.length >= 8) { localStorage.setItem('customerPhone', p); showSection('customer-dashboard'); checkMyOrder(); } else alert('Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­'); }

        function getCustomerLocation(e) {
            e.preventDefault(); const btn = document.getElementById('btn-get-loc'); btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯... â³';
            if ("geolocation" in navigator) { navigator.geolocation.getCurrentPosition(pos => { tempCustLat = pos.coords.latitude; tempCustLng = pos.coords.longitude; btn.classList.add('hidden'); document.getElementById('loc-status').style.display = 'block'; }, err => { alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹."); btn.innerText = 'ğŸ“ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ'; }); }
        }

        function applyCoupon(event) {
            const code = document.getElementById('promo-code').value; if(!code) return;
            const btn = event.target; btn.innerText = 'â³'; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'check_coupon', code: code }) })
            .then(res => res.json()).then(data => {
                const msgBox = document.getElementById('coupon-msg'); msgBox.classList.remove('hidden');
                if(data.status === 'valid') { msgBox.innerText = `âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… ${data.discount}%!`; activePromoCode = code; document.getElementById('promo-code').disabled = true;}
                else { msgBox.innerText = 'âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­.'; msgBox.style.color = 'red'; activePromoCode = ""; }
            }).finally(() => { btn.innerText = 'ØªØ·Ø¨ÙŠÙ‚'; btn.disabled = false; });
        }

        let customerMap, customerMarker; let customerMapInterval;

        function checkMyOrder() {
            const phone = localStorage.getItem('customerPhone'); const statusArea = document.getElementById('customer-status-area'); statusArea.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ùƒ... â³';
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'check_customer_order', phone: phone }) })
            .then(res => res.json()).then(data => {
                if(data.status === "success" && data.activeOrder) {
                    let bc = data.activeOrder.status.includes('Ø§Ù†ØªØ¸Ø§Ø±') || data.activeOrder.status.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©') ? 'badge-wait' : 'badge-prog';
                    statusArea.innerHTML = `<h4 style="margin:0; color:var(--primary-gold);">Ø·Ù„Ø¨Ùƒ: ${data.activeOrder.id}</h4><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge ${bc}">${data.activeOrder.status}</span><br><p style="font-size:13px; color:#666; margin-top:5px;">Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${data.activeOrder.details}</p>`;
                    if(data.activeOrder.status.includes('ØªÙˆØµÙŠÙ„')) {
                        const mapCont = document.getElementById('customer-map-container'); mapCont.classList.remove('hidden');
                        if(data.activeOrder.lat && data.activeOrder.lng && data.activeOrder.custLat && data.activeOrder.custLng) {
                            let dist = calculateDistance(data.activeOrder.lat, data.activeOrder.lng, data.activeOrder.custLat, data.activeOrder.custLng);
                            if(dist) { document.getElementById('eta-display').classList.remove('hidden'); document.getElementById('eta-display').innerHTML = `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${dist} ÙƒÙ… ğŸ›µ | Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${Math.ceil((dist/40)*60)} Ø¯Ù‚ÙŠÙ‚Ø© â±ï¸`; }
                        }
                        setTimeout(() => {
                            let initLat = data.activeOrder.lat || data.activeOrder.custLat || 23.2255; let initLng = data.activeOrder.lng || data.activeOrder.custLng || 56.5165;
                            if(!customerMap) { customerMap = L.map('customer-map').setView([initLat, initLng], 15); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(customerMap); customerMarker = L.marker([initLat, initLng]).addTo(customerMap).bindPopup('Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ğŸ›µ').openPopup(); } 
                            else { customerMarker.setLatLng([initLat, initLng]); customerMap.setView([initLat, initLng]); }
                            customerMap.invalidateSize(); 
                        }, 300);
                        if(!customerMapInterval) customerMapInterval = setInterval(refreshCustomerMapOnly, 5000);
                    } else { document.getElementById('customer-map-container').classList.add('hidden'); if(customerMapInterval) { clearInterval(customerMapInterval); customerMapInterval = null; } }
                } else { statusArea.innerHTML = '<p style="color:green; margin:0;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©. Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†!</p>'; document.getElementById('customer-map-container').classList.add('hidden'); if(customerMapInterval) { clearInterval(customerMapInterval); customerMapInterval = null; } }
            }).catch(e => { statusArea.innerHTML = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„."; });
        }

        function refreshCustomerMapOnly() {
            const phone = localStorage.getItem('customerPhone');
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'check_customer_order', phone: phone }) }).then(res => res.json()).then(data => {
                if(data.status === "success" && data.activeOrder && data.activeOrder.status.includes('ØªÙˆØµÙŠÙ„') && data.activeOrder.lat) {
                    if(customerMap && customerMarker) { customerMarker.setLatLng([data.activeOrder.lat, data.activeOrder.lng]); customerMap.panTo([data.activeOrder.lat, data.activeOrder.lng]); } else if (!customerMap) { checkMyOrder(); }
                } else if (!data.activeOrder || data.activeOrder.status.includes('ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…')) { clearInterval(customerMapInterval); customerMapInterval = null; checkMyOrder(); }
            });
        }

        function submitOrder(e) {
            const payload = { action: 'new_order', phone: localStorage.getItem('customerPhone'), city: document.getElementById('cust-city').value, area: document.getElementById('cust-area').value, pickup: document.getElementById('pickup-loc').value, details: document.getElementById('order-details').value, custLat: tempCustLat, custLng: tempCustLng, promoCode: activePromoCode };
            if(!payload.city || !payload.area || !payload.pickup) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
            const btn = e.target; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...'; btn.disabled = true;
            
            let msg = `âœ¨ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!\nğŸ“ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${payload.phone}\nğŸ“ Ø§Ù„ØªÙˆØµÙŠÙ„: ${payload.city} - ${payload.area}\nğŸª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ${payload.pickup}\nğŸ›ï¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${payload.details}`;
            window.open(`https://wa.me/968${ADMIN_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
            
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(() => {
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!'); checkMyOrder();
                document.getElementById('pickup-loc').value = ''; document.getElementById('order-details').value = ''; document.getElementById('promo-code').value = ''; activePromoCode = ""; document.getElementById('coupon-msg').classList.add('hidden'); document.getElementById('promo-code').disabled = false;
            }).finally(() => { btn.innerText = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ“²'; btn.disabled = false; });
        }

        /* ================= Ø§Ù„ØªÙØ¬Ù‘Ø§Ø± ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù… ================= */
        function loginVendor(e) {
            const id = document.getElementById('vnd-id').value; const pass = document.getElementById('vnd-pass').value; if(!id || !pass) return;
            const btn = e.target; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...'; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login_vendor', id: id, pass: pass }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') { 
                    localStorage.setItem('vendorId', id); localStorage.setItem('vendorName', data.name); 
                    document.getElementById('vendor-welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ù…ØªØ¬Ø± ${data.name} ğŸª`; 
                    showSection('vendor-dashboard'); fetchVendorOrders(); 
                } else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!');
            }).finally(() => { btn.innerText = 'Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªØ§Ø¬Ø±'; btn.disabled = false; });
        }

        function fetchVendorOrders() {
            const vName = localStorage.getItem('vendorName');
            const container = document.getElementById('vendor-orders-list'); container.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª Ø²Ø¨Ø§Ø¦Ù†Ùƒ... â³</p>';
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_vendor_data', vendorName: vName }) })
            .then(res => res.json()).then(data => {
                if(data.status !== "success") return;
                container.innerHTML = '';
                if(data.orders.length === 0) { container.innerHTML = '<p style="color:green; font-weight:bold; font-size:14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'; return; }
                
                data.orders.forEach(o => {
                    let bc = o.status.includes('Ø§Ù†ØªØ¸Ø§Ø±') || o.status.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©') ? 'badge-wait' : 'badge-prog';
                    container.innerHTML += `
                        <div style="border:1px solid #ddd; padding:15px; border-radius:8px; margin-bottom:15px; background:#fff;">
                            <h4 style="margin-top:0; color:var(--primary-gold);">Ø§Ù„Ø·Ù„Ø¨: ${o.id}</h4>
                            <p style="margin:5px 0;"><strong>Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†:</strong> ${o.phone}</p>
                            <p style="margin:5px 0;"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${o.area}</p>
                            <p style="margin:5px 0;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„ØªØ­ØµÙŠÙ„:</strong> ${o.price > 0 ? o.price + ' Ø±.Ø¹' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p style="margin:5px 0;"><strong>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</strong> ${o.driverName}</p>
                            <p style="margin:5px 0;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge ${bc}">${o.status}</span></p>
                        </div>
                    `;
                });
            });
        }

        function submitVendorOrder(e) {
            const vName = localStorage.getItem('vendorName');
            const payload = { action: 'new_order', phone: document.getElementById('vnd-cust-phone').value, city: document.getElementById('vnd-cust-city').value, area: document.getElementById('vnd-cust-area').value, pickup: vName, details: document.getElementById('vnd-order-details').value, price: document.getElementById('vnd-order-price').value || 0 };
            
            if(!payload.phone || !payload.area || !payload.details) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'); return; }
            const btn = e.target; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...'; btn.disabled = true;
            
            let msg = `ğŸª Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø±: ${vName}!\nğŸ“ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${payload.phone}\nğŸ“ Ø§Ù„ØªÙˆØµÙŠÙ„: ${payload.city} - ${payload.area}\nğŸ›ï¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${payload.details}\n${payload.price > 0 ? 'ğŸ’° Ù…Ø·Ù„ÙˆØ¨ ØªØ­ØµÙŠÙ„: '+payload.price+' Ø±.Ø¹' : ''}`;
            window.open(`https://wa.me/968${ADMIN_PHONE}?text=${encodeURIComponent(msg)}`, '_blank');
            
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(() => {
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ø£Ø³Ø·ÙˆÙ„ Ù†Ø¹Ø§ÙˆÙ†!'); fetchVendorOrders();
                document.getElementById('vnd-cust-phone').value = ''; document.getElementById('vnd-cust-city').value = ''; document.getElementById('vnd-cust-area').value = ''; document.getElementById('vnd-order-details').value = ''; document.getElementById('vnd-order-price').value = '';
            }).finally(() => { btn.innerText = 'Ø·Ù„Ø¨ Ù…Ù†Ø¯ÙˆØ¨ ÙÙˆØ±Ø§Ù‹ ğŸ›µ'; btn.disabled = false; });
        }

        /* ================= Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ================= */
        let driverMap, driverMarker;

        function applyDriverStatusUI(status) {
            currentDriverStatus = status; let btn = document.getElementById('drv-status-btn');
            if(status === "ØºÙŠØ± Ù…ØªØ§Ø­") { btn.innerText = "ğŸ”´ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹"; btn.style.background = "#dc3545"; } 
            else { btn.innerText = "ğŸŸ¢ Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„"; btn.style.background = "#28a745"; }
        }

        function toggleDriverStatus() {
            let newStatus = (currentDriverStatus === "Ù…ØªØµÙ„") ? "ØºÙŠØ± Ù…ØªØ§Ø­" : "Ù…ØªØµÙ„";
            applyDriverStatusUI(newStatus); localStorage.setItem('driverStatus', newStatus);
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_driver_status', driverId: localStorage.getItem('driverId'), status: newStatus }) });
        }

        function loginDriver(e) {
            const id = document.getElementById('drv-id').value; const pass = document.getElementById('drv-pass').value; if(!id || !pass) return;
            const btn = e.target; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...'; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login_driver', id: id, pass: pass }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') { 
                    localStorage.setItem('driverId', id); localStorage.setItem('driverName', data.name); localStorage.setItem('driverStatus', data.drvStatus);
                    document.getElementById('driver-welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${data.name} ğŸ›µ`; applyDriverStatusUI(data.drvStatus);
                    showSection('driver-dashboard'); fetchDriverOrders(true); 
                } else alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©!');
            }).finally(() => { btn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'; btn.disabled = false; });
        }

        function fetchDriverOrders(userClicked = false) {
            if(userClicked) { isAudioAllowed = true; } const id = localStorage.getItem('driverId'); const container = document.getElementById('driver-orders-list'); container.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§ØªÙƒ... â³</p>';
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_driver_data', driverId: id }) })
            .then(res => res.json()).then(data => {
                if(data.status !== "success") return;
                let badgeTxt = data.completedCount >= 100 ? "ğŸ’ Ù…Ø§Ø³ÙŠ" : (data.completedCount >= 50 ? "ğŸ¥‡ Ø°Ù‡Ø¨ÙŠ" : (data.completedCount >= 30 ? "ğŸ¥ˆ ÙØ¶ÙŠ" : (data.completedCount >= 10 ? "ğŸ¥‰ Ø¨Ø±ÙˆÙ†Ø²ÙŠ" : "ğŸ›µ Ù…Ø¨ØªØ¯Ø¦")));
                document.getElementById('driver-badge-display').innerText = `Ù…Ø³ØªÙˆØ§Ùƒ: ${badgeTxt} (${data.completedCount} ØªÙˆØµÙŠÙ„Ø©)`;
                container.innerHTML = '';
                
                let assignedOnly = data.orders.filter(o => o.status.includes('ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯'));
                if(assignedOnly.length > lastAssignedOrdersCount && isAudioAllowed) { driverAudio.play().catch(e=>console.log(e)); }
                lastAssignedOrdersCount = assignedOnly.length;

                if(data.orders.length === 0) { container.innerHTML = '<p style="color:green; font-weight:bold; font-size:16px;">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ù†Ø¯Ø© Ù„Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'; document.getElementById('map-container').classList.add('hidden'); return; }

                data.orders.forEach(order => {
                    let actionsHtml = '';
                    if(order.status.includes('ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯')) { actionsHtml = `<button onclick="acceptOrder('${order.id}')" class="btn-success">Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ğŸ“</button>`; } 
                    else if (order.status.includes('Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„')) {
                        let waMsg = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ² ğŸ‘‹\nØ£Ù†Ø§ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙÙŠ Ø·Ø±ÙŠÙ‚ÙŠ Ø¥Ù„ÙŠÙƒ ğŸ›µ\n\nğŸ“¦ *ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ:*\nğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.id}\nğŸ“ Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„: ${order.area}\nØ³Ø£ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ âœ¨`;
                        let waLink = `https://wa.me/968${order.phone}?text=${encodeURIComponent(waMsg)}`;
                        
                        actionsHtml = `
                            <div style="margin: 10px 0; background: #f1f8ff; padding: 10px; border-radius: 5px;">
                                <a href="tel:${order.phone}" style="display:inline-block; padding:8px 15px; background:#17a2b8; color:white; text-decoration:none; border-radius:5px;">ğŸ“ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„</a>
                                <a href="${waLink}" target="_blank" style="display:inline-block; padding:8px 15px; background:#25D366; color:white; text-decoration:none; border-radius:5px;">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„</a>
                            </div>
                            <label style="font-size:14px; font-weight:bold; color:var(--primary-gold);">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…:</label>
                            <input type="number" id="collected-price-${order.id}" class="driver-price-input" placeholder="Ù…Ø«Ø§Ù„: 5.500">
                            <button onclick="completeOrder('${order.id}')" style="background:#dc3545; margin-top:5px;">ØªØ£ÙƒÙŠØ¯ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
                        `;
                        setTimeout(() => { startDriverGPS(order.id); }, 1000);
                    }
                    container.innerHTML += `<div style="border:1px solid #ddd; padding:15px; border-radius:8px; margin-bottom:15px;"><h4 style="margin-top:0; color:var(--primary-gold);">Ø·Ù„Ø¨: ${order.id}</h4><p style="margin:5px 0;"><strong>Ù…Ù†:</strong> ${order.pickup} | <strong>Ø¥Ù„Ù‰:</strong> ${order.area}</p>${actionsHtml}</div>`;
                });
            });
        }

        function acceptOrder(orderId) { fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_status', orderId: orderId, newStatus: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚)', driverId: localStorage.getItem('driverId'), driverName: localStorage.getItem('driverName') }) }).then(() => fetchDriverOrders()); }

        function startDriverGPS(orderId) {
            const mapCont = document.getElementById('map-container'); mapCont.classList.remove('hidden');
            if(!driverMap) { driverMap = L.map('driver-map').setView([23.2255, 56.5165], 14); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(driverMap); } driverMap.invalidateSize();
            if ("geolocation" in navigator && !watchId) {
                watchId = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                    if(!driverMarker) { driverMarker = L.marker([lat, lng]).addTo(driverMap); } else { driverMarker.setLatLng([lat, lng]); }
                    driverMap.panTo([lat, lng]); fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_location', orderId: orderId, lat: lat, lng: lng }) });
                }, err => console.log("GPS"), {enableHighAccuracy: true});
            }
        }

        function completeOrder(orderId) {
            let priceInput = document.getElementById(`collected-price-${orderId}`); let collectedPrice = priceInput ? parseFloat(priceInput.value) : 0;
            if(!collectedPrice || collectedPrice <= 0) { if(!confirm("âš ï¸ Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø·Ù„Ø¨! Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø³Ù„Ù…Øª Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù…Ø¨Ù„Øº 0 Ø±ÙŠØ§Ù„ØŸ")) return; }
            if(confirm("Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ù‚Ù…Øª Ø¨ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ")) {
                if(watchId && navigator.geolocation) { navigator.geolocation.clearWatch(watchId); watchId = null; } document.getElementById('map-container').classList.add('hidden');
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_status', orderId: orderId, newStatus: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', price: collectedPrice }) }).then(() => { alert('Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø¹Ù‡Ø¯ØªÙƒ.'); fetchDriverOrders(); });
            }
        }

        /* ================= Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ================= */
        function loginAdmin(event) { 
            const user = document.getElementById('adm-user').value; const pass = document.getElementById('adm-pass').value; if(!user || !pass) return;
            const btn = event.target; btn.innerText = 'â³'; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login_admin', user: user, pass: pass }) })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') { localStorage.setItem('adminLogged', 'true'); isAudioAllowed = true; showSection('admin-dashboard'); startAdminAutoRefresh(); } else alert('Ø®Ø·Ø£!');
            }).finally(() => { btn.innerText = 'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©'; btn.disabled = false; });
        }

        function startAdminAutoRefresh() { fetchAdminData(); if(!adminRefreshInterval) { adminRefreshInterval = setInterval(fetchAdminData, 5000); } }
        function stopAdminAutoRefresh() { if(adminRefreshInterval) { clearInterval(adminRefreshInterval); adminRefreshInterval = null; } }

        function filterAdminOrders() {
            let input = document.getElementById('admin-search-bar').value.toLowerCase(); let cards = document.querySelectorAll('.admin-order-card');
            cards.forEach(card => { if(card.innerText.toLowerCase().includes(input)) card.style.display = ''; else card.style.display = 'none'; });
        }

        let isFetchingAdmin = false;
        function fetchAdminData() {
            if(isFetchingAdmin) return; isFetchingAdmin = true;
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_admin_data' }) })
            .then(res => res.json()).then(data => {
                if(!document.getElementById('admin-dashboard').classList.contains('hidden')){
                    const newContainer = document.getElementById('admin-new-orders'); const allContainer = document.getElementById('admin-all-orders');
                    newContainer.innerHTML = ''; allContainer.innerHTML = ''; availableDriversData = data.drivers; 
                    
                    if(data.newOrders.length > lastNewOrdersCount && isAudioAllowed) { adminAudio.play().catch(e=>console.log(e)); } lastNewOrdersCount = data.newOrders.length;
                    
                    renderCharts(data.allOrders, data.drivers); renderHeatmap(data.allOrders); 

                    let cashHtml = '';
                    data.drivers.forEach(d => {
                        cashHtml += `<div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ddd; padding:8px 0;">
                            <span>ğŸ›µ ${d.name}</span> <span style="color:var(--dark-gold); font-size:18px;"><strong>${d.cash} Ø±.Ø¹</strong></span>
                            <button onclick="clearDriverCash('${d.id}', '${d.name}', ${d.cash})" style="width:auto; padding:5px 10px; margin:0; background:#28a745; font-size:12px;">ØªØµÙÙŠØ© Ø§Ù„ÙƒØ§Ø´</button>
                        </div>`;
                    });
                    document.getElementById('admin-driver-cash').innerHTML = cashHtml || '<p style="color:#666; font-size:14px; margin:0;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø§Ø¯ÙŠØ¨ Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';

                    if(data.newOrders.length === 0) newContainer.innerHTML = '<p style="color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>';
                    else {
                        let opts = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹...</option>';
                        data.drivers.forEach(d => opts += `<option value="${d.id}" data-name="${d.name}">${d.name} (Ø·Ù„Ø¨Ø§ØªÙ‡: ${d.load})</option>`);
                        data.newOrders.forEach(o => {
                            let encArea = encodeURIComponent(o.area || ''); let encDetails = encodeURIComponent(o.details || '');
                            newContainer.innerHTML += `
                                <div class="admin-order-card" style="border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:8px; border-right: 5px solid var(--primary-gold); background:#fff;">
                                    <h4 style="margin-top:0; color:var(--primary-gold);">Ø·Ù„Ø¨: ${o.id}</h4>
                                    <p style="margin:5px 0;"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${o.area}</p>
                                    <p style="margin:5px 0;"><strong>Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†:</strong> ${o.pickup}</p>
                                    ${o.promoCode ? `<p style="margin:5px 0; color:green;"><strong>ğŸ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø·Ø¨Ù‚:</strong> ${o.promoCode}</p>` : ''}
                                    <p style="margin:5px 0;"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <a href="https://wa.me/968${o.phone}" target="_blank" style="color: green; text-decoration: none; font-weight:bold;">ğŸ’¬ ${o.phone}</a></p>
                                    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                                    <div style="display:flex; flex-direction:column; gap:5px;">
                                        <button onclick="autoAssignOrder('${o.id}', '${o.phone}', '${encArea}', '${encDetails}')" class="btn-smart">ğŸª„ Ø¥Ø³Ù†Ø§Ø¯ Ø°ÙƒÙŠ Ù„Ù„Ù…ØªØ§Ø­ÙŠÙ† ÙÙ‚Ø·</button>
                                        <select id="driver-select-${o.id}">${opts}</select>
                                        <button onclick="assignOrder('${o.id}', '${o.phone}', '${encArea}', '${encDetails}', event)">Ø¥Ø³Ù†Ø§Ø¯ ÙŠØ¯ÙˆÙŠ ğŸ“²</button>
                                    </div>
                                </div>`;
                        });
                    }
                    data.allOrders.reverse().forEach(o => {
                        let badgeClass = o.status.includes('Ø§Ù†ØªØ¸Ø§Ø±') || o.status.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©') ? 'badge-wait' : (o.status.includes('ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…') ? 'badge-done' : 'badge-prog');
                        allContainer.innerHTML += `<div class="admin-order-card" style="border-bottom:1px solid #eee; padding:10px 0; font-size:14px;"><strong>${o.id}</strong> - <span class="badge ${badgeClass}">${o.status}</span><p style="margin:5px 0; color:#555;">Ù…Ù†: ${o.pickup} | Ø¥Ù„Ù‰: ${o.area} <br>Ø§Ù„Ù‡Ø§ØªÙ: ${o.phone} ${o.driverName ? '<br><span style="color:var(--primary-gold)">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: '+o.driverName+'</span>' : ''} ${o.price > 0 ? '<br><span style="color:green; font-weight:bold;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„: '+o.price+' Ø±.Ø¹</span>' : ''}</p></div>`;
                    });
                }
            }).finally(() => { isFetchingAdmin = false; filterAdminOrders(); });
        }

        function clearDriverCash(driverId, driverName, amount) {
            if(amount === 0) { alert('Ø§Ù„Ø¹Ù‡Ø¯Ø© Ù…ØµÙØ±Ø© Ø¨Ø§Ù„ÙØ¹Ù„!'); return; }
            if(confirm(`Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø§Ø³ØªÙ„Ù…Øª (${amount} Ø±.Ø¹) ÙƒØ§Ø´ Ù…Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ${driverName} ÙˆØªØ±ÙŠØ¯ ØªØµÙÙŠØ© Ø¹Ù‡Ø¯ØªÙ‡ØŸ`)) {
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'clear_driver_cash', driverId: driverId }) })
                .then(res => res.json()).then(data => { if(data.status === 'success') { alert('ØªÙ… ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!'); fetchAdminData(); } });
            }
        }

        function archiveCompletedOrders() {
            if(confirm('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…!\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ØŸ\nØ³ÙŠØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„ØªÙŠ ØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡Ø§ ÙˆØªØµÙÙŠØ© Ø¹Ù‡Ø¯ØªÙ‡Ø§ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙÙ‚Ø·) Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ù†Ø¸Ø§Ù….')) {
                document.querySelector('button[onclick="archiveCompletedOrders()"]').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø£Ø±Ø´ÙØ©... â³";
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'archive_orders' }) })
                .then(res => res.json()).then(data => {
                    if(data.status === 'success') { alert(`âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ù†Ù‚Ù„ (${data.archivedCount}) Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.`); fetchAdminData(); }
                }).finally(() => { document.querySelector('button[onclick="archiveCompletedOrders()"]').innerText = "ğŸ—„ï¸ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ… ÙˆØ£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©"; });
            }
        }

        function autoAssignOrder(orderId, phone, encArea, encDetails) {
            if(availableDriversData.length === 0) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø§Ø¯ÙŠØ¨ Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹!'); return; }
            let bestDriver = availableDriversData.reduce((prev, curr) => (prev.load < curr.load) ? prev : curr);
            let area = decodeURIComponent(encArea); let details = decodeURIComponent(encDetails);
            if(confirm(`Ø³ÙŠØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ø°ÙƒÙŠØ§Ù‹ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨: ${bestDriver.name}\n(Ù„Ø¯ÙŠÙ‡ ${bestDriver.load} Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹).\nÙ‡Ù„ ØªÙˆØ§ÙÙ‚ØŸ`)) {
                let msg = `ğŸŒŸ Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²ØŒ\nØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨: ${bestDriver.name} ğŸ›µ\n\nğŸ“¦ *ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ:*\nğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${orderId}\nğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†: ${phone}\nğŸ“ Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„: ${area}\nğŸ›ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©: ${details}\n\nÙŠÙ…ÙƒÙ†Ùƒ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¢Ù†!`;
                window.open(`https://wa.me/968${phone}?text=${encodeURIComponent(msg)}`, '_blank');
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_status', orderId: orderId, newStatus: 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨', driverId: bestDriver.id, driverName: bestDriver.name }) }).then(() => fetchAdminData());
            }
        }

        function assignOrder(orderId, phone, encArea, encDetails, event) {
            const select = document.getElementById(`driver-select-${orderId}`); if(!select.value) { alert('Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨!'); return; }
            event.target.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯...';
            let driverName = select.options[select.selectedIndex].getAttribute('data-name'); let area = decodeURIComponent(encArea); let details = decodeURIComponent(encDetails);
            let msg = `ğŸŒŸ Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²ØŒ\nØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨: ${driverName} ğŸ›µ\n\nğŸ“¦ *ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ:*\nğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${orderId}\nğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†: ${phone}\nğŸ“ Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„: ${area}\nğŸ›ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©: ${details}\n\nÙŠÙ…ÙƒÙ†Ùƒ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¢Ù†!`;
            window.open(`https://wa.me/968${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_status', orderId: orderId, newStatus: 'ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨', driverId: select.value, driverName: driverName }) }).then(() => fetchAdminData());
        }

        function renderCharts(orders, drivers) {
            let pCount = 0, iCount = 0, dCount = 0;
            orders.forEach(o => { if(o.status.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©') || o.status.includes('Ø§Ù†ØªØ¸Ø§Ø±')) pCount++; else if(o.status.includes('ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…')) dCount++; else iCount++; });
            drivers.sort((a,b) => b.load - a.load); let topDNames = drivers.slice(0,5).map(d => d.name); let topDLoads = drivers.slice(0,5).map(d => d.load);
            Chart.defaults.font.family = 'Cairo';
            if(chart1) { chart1.data.datasets[0].data = [pCount, iCount, dCount]; chart1.update(); } else { chart1 = new Chart(document.getElementById('statusChart'), { type: 'doughnut', data: { labels: ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„', 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'], datasets: [{ data: [pCount, iCount, dCount], backgroundColor: ['#ffc107', '#17a2b8', '#28a745'] }] } }); }
            if(chart2) { chart2.data.labels = topDNames; chart2.data.datasets[0].data = topDLoads; chart2.update(); } else { chart2 = new Chart(document.getElementById('driversChart'), { type: 'bar', data: { labels: topDNames, datasets: [{ label: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©', data: topDLoads, backgroundColor: '#D4AF37' }] }}); }
        }
    </script>
</body>
</html>
